<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>ChatLearner</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    #chat-box {
      height: 70vh;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 15px;
      background: white;
    }
    .msg { margin-bottom: 10px; max-width: 75%; padding: 10px 15px; border-radius: 15px; }
    .msg.user { background: #0d6efd; color: white; margin-left: auto; text-align: right; }
    .msg.assistant { background: #f1f3f5; text-align: left; }
  </style>
</head>
<body>
<div class="container py-4">
  <h3 class="mb-3">üìö ChatLearner</h3>

  <div id="chat-box">
    <div class="msg assistant">Hi! Upload a file, paste a YouTube link, or a website ‚Äî then ask me anything!</div>
  </div>

  <form id="chat-form" class="mt-3" method="post">
    {% csrf_token %}
    <div class="input-group mb-2">
      <input type="text" id="user-input" class="form-control" placeholder="Ask your question...">
      <button class="btn btn-primary" type="submit">Send</button>
    </div>

    <div class="mb-2">
      <label class="form-label">Upload Documents</label>
      <input type="file" id="file-input" class="form-control" multiple>
    </div>

    <div class="mb-2">
      <label class="form-label">YouTube Link</label>
      <input type="url" id="youtube-link" class="form-control" placeholder="https://youtube.com/watch?v=...">
    </div>

    <div class="mb-2">
      <label class="form-label">Website URL</label>
      <input type="url" id="website-link" class="form-control" placeholder="https://example.com">
    </div>
  </form>

</div>

<script>
const chatBox = document.getElementById("chat-box");
const chatForm = document.getElementById("chat-form");
const userInput = document.getElementById("user-input");
const fileInput = document.getElementById("file-input");
const youtubeInput = document.getElementById("youtube-link");
const websiteInput = document.getElementById("website-link");

function getCSRFToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

const csrftoken = getCSRFToken();

function addMessage(text, role = "assistant") {
  const msg = document.createElement("div");
  msg.classList.add("msg", role);
  msg.textContent = text;
  chatBox.appendChild(msg);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function extractYoutubeId(url) {
  try {
    const u = new URL(url);
    if (u.hostname.includes("youtube.com")) return u.searchParams.get("v");
    if (u.hostname === "youtu.be") return u.pathname.slice(1);
  } catch {}
  return null;
}

// ‚úÖ Auto-upload when files are selected
fileInput.addEventListener("change", async (e) => {
  const files = e.target.files;
  if (!files.length) return;

  // Add message feedback to chat
  const uploadMsg = document.createElement("div");
  uploadMsg.classList.add("msg", "assistant");
  uploadMsg.textContent = "üì§ Uploading document(s)...";
  chatBox.appendChild(uploadMsg);
  chatBox.scrollTop = chatBox.scrollHeight;

  const formData = new FormData();
  for (let f of files) {
    formData.append("files", f);
  }

  try {
    const resp = await fetch("http://127.0.0.1:8000/api/documents/upload/", {
      method: "POST",
      headers: { "X-CSRFToken": csrftoken },
      body: formData
    });

    const data = await resp.json();

    if (resp.ok) {
      uploadMsg.textContent = `‚úÖ Uploaded ${data.documents.length} file(s) successfully.`;
    } else {
      uploadMsg.textContent = `‚ö†Ô∏è Upload failed: ${data.error || JSON.stringify(data)}`;
    }
  } catch (err) {
    uploadMsg.textContent = "‚ö†Ô∏è Error during upload: " + err.message;
  }
});

// ‚úÖ Chat form submission
chatForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const text = userInput.value.trim();
  const youtubeUrl = youtubeInput.value.trim();
  const websiteUrl = websiteInput.value.trim();

  if (!text && !youtubeUrl && !websiteUrl) return;

  // Add user message
  addMessage(text || "[Sent link]", "user");
  userInput.value = "";

  // Placeholder response
  const placeholder = document.createElement("div");
  placeholder.classList.add("msg", "assistant");
  placeholder.textContent = "ü§ñ Thinking...";
  chatBox.appendChild(placeholder);
  chatBox.scrollTop = chatBox.scrollHeight;

  try {
    // Process YouTube link
    if (youtubeUrl) {
      const vid = extractYoutubeId(youtubeUrl);
      await fetch("http://127.0.0.1:8000/chatlearner/", {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken, "Content-Type": "application/json" },
        body: JSON.stringify({ type: "youtube", url: youtubeUrl, videoId: vid })
      });
    }

    // Process Website link
    if (websiteUrl) {
      await fetch("http://127.0.0.1:8000/chatlearner/", {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken, "Content-Type": "application/json" },
        body: JSON.stringify({ type: "website", url: websiteUrl })
      });
    }

    // Send the actual question
    const resp = await fetch("http://127.0.0.1:8000/chatlearner/", {
      method: "POST",
      headers: { "X-CSRFToken": csrftoken, "Content-Type": "application/json" },
      body: JSON.stringify({ question: text || "Summarize the uploaded content" })
    });

    const data = await resp.json();
    placeholder.textContent = data.answer || JSON.stringify(data);
  } catch (err) {
    placeholder.textContent = "‚ö†Ô∏è Error: " + err.message;
  }
});
</script>

</body>
</html>
